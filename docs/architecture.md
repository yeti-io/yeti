# ğŸ—ï¸ ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

## ĞĞ³Ğ»Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
1. [ĞĞ±Ñ‰ĞµĞµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ](#Ğ¾Ğ±Ñ‰ĞµĞµ-Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ)
2. [Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹](#Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°-ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹)
3. [ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹](#ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹-ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹)
4. [Ğ’Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼Ğ¸](#Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ-Ğ¼ĞµĞ¶Ğ´Ñƒ-ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼Ğ¸)
5. [Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ñ‹](#Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğµ-ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ñ‹)

---

## ĞĞ±Ñ‰ĞµĞµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ

Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑĞ¾Ğ±Ğ¾Ğ¹ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ½Ñ‹Ğ¹ pipeline Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ñ‹Ğ¼Ğ¸ Ğ¼Ğ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼Ğ¸, ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ¸Ğ· ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ½Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ¼ ÑÑ‚Ğ°Ğ¿Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸. ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚:

- âœ… ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾
- âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑÑ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ±ĞµĞ· Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
- âœ… Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚ÑŒ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ°Ğ¿Ğ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
- âœ… ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ¸ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
- âœ… Ğ›ĞµĞ³ĞºĞ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑÑ‚Ğ°Ğ¿Ñ‹ Ğ² Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¼

---

## Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         INPUT MESSAGE                             â”‚
â”‚                      (Incoming Data Stream)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Message Broker - INPUT     â”‚
        â”‚   (Kafka)                     â”‚
        â”‚   Topic: input_events        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   FILTERING SERVICE                   â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ â€¢ Ğ§Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸           â”‚
        â”‚ â€¢ ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ Ğº ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑĞ¼     â”‚
        â”‚ â€¢ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ   â”‚
        â”‚                                       â”‚
        â”‚ Database: PostgreSQL                  â”‚
        â”‚ Rules Cache: In-Memory (RWMutex)     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ (passed messages)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Message Broker - DEDUP INPUT       â”‚
        â”‚   Topic: dedup_events                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   DEDUPLICATION SERVICE               â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ â€¢ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ   â”‚
        â”‚ â€¢ Ğ¥Ñ€Ğ°Ğ½Ğ¸Ñ‚ Ñ…ĞµÑˆĞ¸ Ğ² Redis Ñ TTL          â”‚
        â”‚ â€¢ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ   â”‚
        â”‚                                       â”‚
        â”‚ Database: Redis (with TTL)           â”‚
        â”‚ Window: Configurable (default 1h)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ (unique messages)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Message Broker - ENRICHMENT INPUT  â”‚
        â”‚   Topic: enrichment_events            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   ENRICHMENT SERVICE                  â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ â€¢ ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ       â”‚
        â”‚ â€¢ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ñ… API   â”‚
        â”‚ â€¢ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğº ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑĞ¼   â”‚
        â”‚                                       â”‚
        â”‚ Database: MongoDB                     â”‚
        â”‚ Cache: Redis (Ğ´Ğ»Ñ Ñ‡Ğ°ÑÑ‚Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ (enriched messages)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Message Broker - OUTPUT             â”‚
        â”‚   Topic: processed_events             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   OUTPUT MESSAGE             â”‚
        â”‚   (Ready for Consumption)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     MANAGEMENT SERVICE (REST API)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Endpoints:                                                        â”‚
â”‚ â€¢ GET/POST/PUT/DELETE  /api/v1/rules/filtering                  â”‚
â”‚ â€¢ GET/POST/PUT/DELETE  /api/v1/rules/deduplication              â”‚
â”‚ â€¢ GET/POST/PUT/DELETE  /api/v1/rules/enrichment                 â”‚
â”‚ â€¢ GET                  /api/v1/health                            â”‚
â”‚ â€¢ GET                  /api/v1/stats                             â”‚
â”‚ â€¢ GET                  /api/v1/metrics                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MONITORING & LOGGING                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Prometheus:  :8080/metrics (Ğ¾Ñ‚ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ ÑĞµÑ€Ğ²Ğ¸ÑĞ°)              â”‚
â”‚ â€¢ Grafana:     :3000 (Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº)                     â”‚
â”‚ â€¢ ELK Stack:   :5601 (Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ - Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)               â”‚
â”‚ â€¢ Jaeger:      :16686 (distributed tracing - Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

### 1. **Filtering Service** ğŸ”

#### ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ
ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ°Ğ¿ pipeline - Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°Ğ¼. ĞÑ‚ÑĞµĞ¸Ğ²Ğ°ĞµÑ‚ Ğ½ĞµĞ¶ĞµĞ»Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ´Ğ¾ Ñ‚Ğ¾Ğ³Ğ¾, ĞºĞ°Ğº Ğ¾Ğ½Ğ¸ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ñ‹ Ğ½Ğ° ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ñ… ÑÑ‚Ğ°Ğ¿Ğ°Ñ….

#### ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ
- Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¸ ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
- ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» Ğº Ğ²Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑĞ¼
- Hot reload Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» Ğ±ĞµĞ· Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ÑĞµÑ€Ğ²Ğ¸ÑĞ°
- ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ (Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ğ½Ñ‹Ğµ/Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ)

#### Ğ¢Ğ¸Ğ¿Ñ‹ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
```
1. Exact Match (eq)         - Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
2. Contains (contains)      - ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ¿Ğ¾Ğ´ÑÑ‚Ñ€Ğ¾ĞºÑƒ
3. Regex (regex)            - ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ñ€ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğ¼Ñƒ Ğ²Ñ‹Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
4. Greater Than (gt)        - Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ (Ñ‡Ğ¸ÑĞ»Ğ¾Ğ²Ğ¾Ğµ)
5. Less Than (lt)           - Ğ¼ĞµĞ½ÑŒÑˆĞµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ (Ñ‡Ğ¸ÑĞ»Ğ¾Ğ²Ğ¾Ğµ)
6. In List (in)             - Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¸Ğ· ÑĞ¿Ğ¸ÑĞºĞ°
7. Range (range)            - Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ² Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ [min, max]
```

#### Ğ’Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
```json
{
  "id": "msg-12345",
  "timestamp": "2025-12-14T14:55:00Z",
  "source": "api-gateway",
  "user_id": "user-789",
  "event_type": "purchase",
  "amount": 99.99,
  "status": "active",
  "email": "user@example.com",
  "payload": {...}
}
```

#### Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
```json
{
  "id": "msg-12345",
  "timestamp": "2025-12-14T14:55:00Z",
  "source": "api-gateway",
  "user_id": "user-789",
  "event_type": "purchase",
  "amount": 99.99,
  "status": "active",
  "email": "user@example.com",
  "payload": {...},
  "filters_applied": {
    "rule_ids": ["rule-1", "rule-2"],
    "passed_at": "2025-12-14T14:55:00.123Z"
  }
}
```

#### Database Schema (PostgreSQL)
```sql
-- Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
CREATE TABLE filtering_rules (
  id UUID PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  field VARCHAR(255) NOT NULL,
  operator VARCHAR(50) NOT NULL,
  value JSONB NOT NULL,
  enabled BOOLEAN DEFAULT true,
  priority INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  version INTEGER DEFAULT 1
);

-- Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹
CREATE INDEX idx_filtering_rules_enabled ON filtering_rules(enabled);
CREATE INDEX idx_filtering_rules_priority ON filtering_rules(priority DESC);

-- Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ»Ğ¾Ğ³Ğ¾Ğ² Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
CREATE TABLE filtering_logs (
  id UUID PRIMARY KEY,
  rule_id UUID REFERENCES filtering_rules(id),
  message_id VARCHAR(255),
  matched BOOLEAN,
  execution_time_ms INTEGER,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### ĞšĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
- **Ğ’ Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸**: RWMutex Ğ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ğ½Ñ‹Ğ¹ map[string]*CompiledRule
- **ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ**: ĞĞ° SIGHUP ÑĞ¸Ğ³Ğ½Ğ°Ğ» Ğ¸Ğ»Ğ¸ Ñ‡ĞµÑ€ĞµĞ· API
- **ĞšĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ†Ğ¸Ñ Regex**: ĞŸÑ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»
- **TTL**: ĞĞµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ (Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ğ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ)

---

### 2. **Deduplication Service** ğŸ”„

#### ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ
Ğ’Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ ÑÑ‚Ğ°Ğ¿ pipeline - Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ². Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚, Ñ‡Ñ‚Ğ¾ Ğ¾Ğ´Ğ½Ğ¾ Ğ¸ Ñ‚Ğ¾ Ğ¶Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ·.

#### ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ
- Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ğµ Ñ…ĞµÑˆĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ Ğ² Redis Ñ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ¾ĞºĞ½Ğ¾Ğ¼
- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ TTL Ğ´Ğ»Ñ Ğ¾ĞºĞ½Ğ° Ğ´ĞµĞ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
- ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ² Ğ¸ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹

#### ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ğ´ĞµĞ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
```
1. Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ¸Ğ· ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ (id, timestamp, source)
2. Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»Ğ¸Ñ‚ÑŒ MD5 Ñ…ĞµÑˆ: hash = md5(id + timestamp + source)
3. ĞŸĞ¾Ğ¿Ñ‹Ñ‚Ğ°Ñ‚ÑŒÑÑ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ² Redis: SET dedup:{hash} {timestamp} EX {window}
4. Ğ•ÑĞ»Ğ¸ SET ÑƒÑĞ¿ĞµÑˆĞµĞ½ -> ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾
5. Ğ•ÑĞ»Ğ¸ SET Ğ²ĞµÑ€Ğ½ÑƒĞ» nil -> ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚
```

#### Ğ’Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
```json
{
  "id": "msg-12345",
  "timestamp": "2025-12-14T14:55:00Z",
  "source": "api-gateway",
  // ... Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ
  "filters_applied": {
    "rule_ids": ["rule-1", "rule-2"],
    "passed_at": "2025-12-14T14:55:00.123Z"
  }
}
```

#### Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
```json
{
  "id": "msg-12345",
  "timestamp": "2025-12-14T14:55:00Z",
  "source": "api-gateway",
  // ... Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ
  "filters_applied": {
    "rule_ids": ["rule-1", "rule-2"],
    "passed_at": "2025-12-14T14:55:00.123Z"
  },
  "deduplication": {
    "is_unique": true,
    "hash": "abc123def456",
    "checked_at": "2025-12-14T14:55:00.456Z"
  }
}
```

#### Redis Schema
```
Key Pattern:    dedup:{hash}
Value:          timestamp (Unix)
TTL:            configurable (default 3600 seconds / 1 hour)

Example:
Key:    dedup:a1b2c3d4e5f6g7h8
Value:  1734268500
TTL:    3600 (expires automatically)
```

#### ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
```yaml
deduplication:
  window_seconds: 3600        # 1 Ñ‡Ğ°Ñ
  fields_for_hash:
    - id
    - timestamp
    - source
  hash_algorithm: md5         # Ğ¸Ğ»Ğ¸ sha256
```

#### ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
- **Redis Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½**: ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ² DLQ, Ğ·Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ
- **ĞĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ**: ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ´ĞµĞ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ, Ğ·Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ warning
- **Timeout Redis**: Retry 3 Ñ€Ğ°Ğ·Ğ° Ñ exponential backoff

---

### 3. **Enrichment Service** ğŸ

#### ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ
Ğ¢Ñ€ĞµÑ‚Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ¿ pipeline - Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¸Ğ· Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ñ… Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¾Ğ² Ğ¸Ğ»Ğ¸ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ñ… Ğ±Ğ°Ğ· Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….

#### ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ
- Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°Ğ¼Ğ¸ Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ
- Ğ’Ñ‹Ğ·Ğ¾Ğ² Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ñ… API/ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
- Ğ¢Ñ€Ğ°Ğ½ÑÑ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
- ĞšĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ
- Hot reload Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»

#### Ğ¢Ğ¸Ğ¿Ñ‹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¾Ğ² Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ
```
1. API Services       - Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹ HTTP API
2. Database Lookup    - Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğº MongoDB/PostgreSQL
3. Cache Lookup       - Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· Redis
4. File Lookup        - Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
5. ML Model           - Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹ ML ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
6. Aggregation        - Ğ°Ğ³Ñ€ĞµĞ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¾Ğ²
```

#### Ğ’Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
```json
{
  "id": "msg-12345",
  "timestamp": "2025-12-14T14:55:00Z",
  "source": "api-gateway",
  "user_id": "user-789",
  "email": "user@example.com",
  "event_type": "purchase",
  "amount": 99.99,
  "country": "US",
  "filters_applied": {...},
  "deduplication": {...}
}
```

#### Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
```json
{
  "id": "msg-12345",
  "timestamp": "2025-12-14T14:55:00Z",
  "source": "api-gateway",
  "user_id": "user-789",
  "email": "user@example.com",
  "event_type": "purchase",
  "amount": 99.99,
  "country": "US",
  "filters_applied": {...},
  "deduplication": {...},
  "enrichment": {
    "user_profile": {
      "name": "John Doe",
      "account_age_days": 365,
      "subscription_tier": "premium",
      "lifetime_value": 5000.00
    },
    "geo_data": {
      "city": "New York",
      "region": "NY",
      "timezone": "America/New_York",
      "latitude": 40.7128,
      "longitude": -74.0060
    },
    "risk_score": 0.15,
    "rules_applied": ["rule-1", "rule-3"],
    "enriched_at": "2025-12-14T14:55:00.789Z"
  }
}
```

#### Database Schema (MongoDB)
```javascript
// Collections: enrichment_rules
db.enrichment_rules.createCollection("enrichment_rules", {
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["_id", "name", "source_type", "enabled"],
      properties: {
        _id: { bsonType: "objectId" },
        name: { bsonType: "string", description: "Ğ˜Ğ¼Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ" },
        field_to_enrich: { bsonType: "string", description: "ĞŸĞ¾Ğ»Ğµ Ğ² ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸" },
        source_type: { 
          enum: ["api", "database", "cache", "file", "ml"],
          description: "Ğ¢Ğ¸Ğ¿ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ°"
        },
        source_config: { bsonType: "object", description: "ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ°" },
        transformation_rules: { bsonType: "array", description: "ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ñ‚Ñ€Ğ°Ğ½ÑÑ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸" },
        cache_ttl_seconds: { bsonType: "int", description: "TTL ĞºĞµÑˆĞ°" },
        enabled: { bsonType: "bool" },
        priority: { bsonType: "int", default: 0 },
        created_at: { bsonType: "date" },
        updated_at: { bsonType: "date" }
      }
    }
  }
});

// Collections: enrichment_cache
db.enrichment_cache.createCollection("enrichment_cache", {});
// TTL index
db.enrichment_cache.createIndex(
  { "created_at": 1 },
  { expireAfterSeconds: 3600 }
);
```

#### ĞšĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
- **Redis**: ĞšĞµÑˆ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ñ TTL
- **ĞšĞ»ÑÑ‡**: `enrich:{rule_id}:{source_hash}`
- **Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ**: JSON Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ
- **TTL**: Ğ˜Ğ· ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° (default 3600 sec)

#### ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
```
Ğ•ÑĞ»Ğ¸ Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ° Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ:
1. Log Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ñ details
2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ fallback Ğ² ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğµ
3. Ğ•ÑĞ»Ğ¸ fallback ĞµÑÑ‚ÑŒ - Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞµĞ³Ğ¾
4. Ğ•ÑĞ»Ğ¸ fallback Ğ½ĞµÑ‚ - Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»Ñ
5. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ»ÑŒÑˆĞµ (Ğ½Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ pipeline)
```

---

### 4. **Management Service** ğŸ›ï¸

#### ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ
REST API Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°Ğ¼Ğ¸ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ². ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°Ğ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ´Ğ°.

#### ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ
- CRUD Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ½Ğ°Ğ´ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°Ğ¼Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
- CRUD Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ½Ğ°Ğ´ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°Ğ¼Ğ¸ Ğ´ĞµĞ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
- CRUD Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ½Ğ°Ğ´ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°Ğ¼Ğ¸ Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ
- Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ¾Ğ± Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸ÑÑ…
- ValidĞ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» Ğ¿ĞµÑ€ĞµĞ´ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸ĞµĞ¼
- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ²ĞµÑ€ÑĞ¸ÑĞ¼Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»
- Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¸ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³

#### REST API Endpoints

**Filtering Rules**
```
GET     /api/v1/rules/filtering           - ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»
POST    /api/v1/rules/filtering           - ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾
GET     /api/v1/rules/filtering/:id       - Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ¿Ğ¾ ID
PUT     /api/v1/rules/filtering/:id       - Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾
DELETE  /api/v1/rules/filtering/:id       - ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾
PATCH   /api/v1/rules/filtering/:id/toggle - Ğ²ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ/Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ
```

**Deduplication Rules**
```
GET     /api/v1/rules/deduplication       - Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ´ĞµĞ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
PUT     /api/v1/rules/deduplication       - Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹
GET     /api/v1/rules/deduplication/stats - ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ²
```

**Enrichment Rules**
```
GET     /api/v1/rules/enrichment          - ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»
POST    /api/v1/rules/enrichment          - ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾
GET     /api/v1/rules/enrichment/:id      - Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ¿Ğ¾ ID
PUT     /api/v1/rules/enrichment/:id      - Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾
DELETE  /api/v1/rules/enrichment/:id      - ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾
PATCH   /api/v1/rules/enrichment/:id/toggle - Ğ²ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ/Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ
```

**System**
```
GET     /api/v1/health                    - Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒÑ
GET     /api/v1/health/services           - ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
GET     /api/v1/stats                     - ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
GET     /api/v1/stats/pipeline            - ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ ÑÑ‚Ğ°Ğ¿Ğ°Ğ¼
GET     /api/v1/metrics                   - Prometheus Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
POST    /api/v1/rules/reload-signal       - Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ SIGHUP ÑĞ¸Ğ³Ğ½Ğ°Ğ»
```

#### Request/Response Examples

**Create Filtering Rule**
```http
POST /api/v1/rules/filtering
Content-Type: application/json

{
  "name": "Filter by status",
  "field": "status",
  "operator": "eq",
  "value": "active",
  "priority": 1,
  "enabled": true
}

Response 201:
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Filter by status",
  "field": "status",
  "operator": "eq",
  "value": "active",
  "priority": 1,
  "enabled": true,
  "created_at": "2025-12-14T14:55:00Z",
  "updated_at": "2025-12-14T14:55:00Z",
  "version": 1
}
```

**Update Enrichment Rule**
```http
PUT /api/v1/rules/enrichment/550e8400-e29b-41d4-a716-446655440001
Content-Type: application/json

{
  "name": "Enrich with user profile",
  "source_type": "api",
  "source_config": {
    "url": "https://user-service/api/users/{user_id}",
    "timeout_ms": 5000,
    "retry_count": 3
  },
  "cache_ttl_seconds": 1800,
  "enabled": true
}

Response 200: {...Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾...}
```

**Get Stats**
```http
GET /api/v1/stats

Response 200:
{
  "timestamp": "2025-12-14T14:55:00Z",
  "total_messages_processed": 1000000,
  "pipeline": {
    "filtering": {
      "input": 1000000,
      "passed": 850000,
      "filtered": 150000,
      "error_rate": 0.001
    },
    "deduplication": {
      "input": 850000,
      "unique": 800000,
      "duplicate": 50000,
      "error_rate": 0.0
    },
    "enrichment": {
      "input": 800000,
      "enriched": 790000,
      "partial_enrich": 10000,
      "error_rate": 0.002,
      "cache_hit_rate": 0.75
    }
  },
  "uptime_seconds": 86400
}
```

#### Database Schema (PostgreSQL)
```sql
-- Ğ’ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»
CREATE TABLE rule_versions (
  id UUID PRIMARY KEY,
  rule_id UUID NOT NULL,
  rule_type VARCHAR(50) NOT NULL,
  rule_data JSONB NOT NULL,
  version INTEGER NOT NULL,
  changed_by VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(rule_id, version)
);

-- ĞÑƒĞ´Ğ¸Ñ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹
CREATE TABLE rule_audit_log (
  id UUID PRIMARY KEY,
  rule_id UUID,
  rule_type VARCHAR(50),
  action VARCHAR(50),
  old_value JSONB,
  new_value JSONB,
  changed_by VARCHAR(255),
  timestamp TIMESTAMP DEFAULT NOW()
);

-- Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹
CREATE INDEX idx_rule_audit_timestamp ON rule_audit_log(timestamp DESC);
CREATE INDEX idx_rule_audit_rule_id ON rule_audit_log(rule_id);
```

---

### 5. **Message Broker** ğŸ“¬

#### ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ
ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼Ğ¸. Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¸ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾ÑÑ‚ÑŒ.

#### Ğ’Ñ‹Ğ±Ğ¾Ñ€: Apache Kafka
```
Apache Kafka - Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚: Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾ÑÑ‚ÑŒ, Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ, Ğ²Ñ‹ÑĞ¾ĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ½Ğ°Ñ ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ½Ğ¾ÑÑ‚ÑŒ
```

#### Ğ¢Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ Ñ‚Ğ¾Ğ¿Ğ¸ĞºĞ¾Ğ² (Kafka)
```
Topics:
â”œâ”€â”€ input_events              (input Ğ´Ğ»Ñ Filtering Service)
â”œâ”€â”€ dedup_events              (output Filtering â†’ input Deduplication)
â”œâ”€â”€ enrichment_events         (output Deduplication â†’ input Enrichment)
â”œâ”€â”€ processed_events          (output Enrichment â†’ final output)
â””â”€â”€ config_updates            (Ğ´Ğ»Ñ event-driven hot reload)

Consumer Groups:
â”œâ”€â”€ filtering-service         (Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ input_events)
â”œâ”€â”€ dedup-service             (Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ dedup_events)
â”œâ”€â”€ enrichment-service        (Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ enrichment_events)
â””â”€â”€ config-watchers           (Ñ‡Ğ¸Ñ‚Ğ°ÑÑ‚ config_updates)
```

#### Message Format
```json
{
  "id": "msg-12345",
  "timestamp": "2025-12-14T14:55:00Z",
  "source": "api-gateway",
  "correlation_id": "corr-98765",
  "trace_id": "trace-54321",
  "payload": {...},
  "metadata": {
    "version": 1,
    "content_type": "application/json",
    "encoding": "utf-8"
  }
}
```

---

## Ğ’Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼Ğ¸

### Message Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Message Lifecycle                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Stage 1: Filtering Service
â”œâ”€ Read: input_events queue
â”œâ”€ Process: Apply filtering rules
â”œâ”€ Check: Rules cache (RWMutex protected)
â”œâ”€ Decision: Pass or Filter
â”œâ”€ Output: dedup_events queue
â””â”€ Metrics: filtering.messages.total, filtering.passed, filtering.filtered

Stage 2: Deduplication Service
â”œâ”€ Read: dedup_events queue
â”œâ”€ Process: Hash message and check Redis
â”œâ”€ Check: Redis with TTL window
â”œâ”€ Decision: Unique or Duplicate
â”œâ”€ Output: enrichment_events queue
â””â”€ Metrics: dedup.unique, dedup.duplicate, dedup.cache_hits

Stage 3: Enrichment Service
â”œâ”€ Read: enrichment_events queue
â”œâ”€ Process: Apply enrichment rules
â”œâ”€ Fetch: Data from external sources (with cache)
â”œâ”€ Transform: Enrich message with data
â”œâ”€ Output: processed_events queue
â””â”€ Metrics: enrichment.processed, enrichment.errors, enrichment.cache_hit_ratio

Stage 4: Output
â”œâ”€ Read: processed_events queue
â”œâ”€ Use: By downstream consumers
â””â”€ Audit: Optional audit logging

Error Handling:
â”œâ”€ Stage 1-3 error â†’ send to corresponding DLQ
â”œâ”€ DLQ message â†’ retry handler or manual review
â””â”€ Max retries â†’ system_dlq (final dead letter)
```

### Management Service Integration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Management Service (REST)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚               â”‚             â”‚             â”‚
       â–¼               â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL â”‚  â”‚ PostgreSQL â”‚ â”‚ PostgreSQL â”‚ â”‚ RabbitMQ   â”‚
â”‚ (Filtering)â”‚  â”‚(Management)â”‚ â”‚(Versioning)â”‚ â”‚(Broadcast) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚               â”‚             â”‚             â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
                  â”‚ Servicesâ”‚
                  â”‚ Read    â”‚
                  â”‚ Config  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Hot Reload Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Admin updates rule via API â”‚
â”‚  PUT /api/v1/rules/filteringâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Management Service          â”‚
â”‚ 1. Validate rule            â”‚
â”‚ 2. Save to PostgreSQL       â”‚
â”‚ 3. Log to audit table       â”‚
â”‚ 4. Send notification        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                      â”‚
      â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Polling      â”‚    â”‚ Event-driven        â”‚
â”‚ (Option 1)   â”‚    â”‚ (Option 2)          â”‚
â”‚              â”‚    â”‚                     â”‚
â”‚ Service      â”‚    â”‚ Service subscribe   â”‚
â”‚ reads file   â”‚    â”‚ to RabbitMQ message â”‚
â”‚ every 5 sec  â”‚    â”‚ "config.updated"    â”‚
â”‚              â”‚    â”‚                     â”‚
â”‚ SIGHUP       â”‚    â”‚ Immediate update    â”‚
â”‚ (Option 3)   â”‚    â”‚                     â”‚
â”‚              â”‚    â”‚                     â”‚
â”‚ Service      â”‚    â”‚ <1 sec delay        â”‚
â”‚ reloads on   â”‚    â”‚                     â”‚
â”‚ signal       â”‚    â”‚                     â”‚
â”‚              â”‚    â”‚                     â”‚
â”‚ <1 min delay â”‚    â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Filtering Service           â”‚
â”‚ 1. Acquire write lock       â”‚
â”‚ 2. Load new rules           â”‚
â”‚ 3. Compile regex patterns   â”‚
â”‚ 4. Release write lock       â”‚
â”‚ 5. Log info message         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ New rules active            â”‚
â”‚ for all new messages        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ñ‹

### 1. Filtering Service Contract

#### Input Message Type
```go
type Message map[string]interface{}

// Minimum required fields
type MinimalMessage struct {
    ID        string
    Timestamp time.Time
    Source    string
    // other fields...
}
```

#### Rule Evaluation Contract
```
Input:  Message, Rule
Output: bool (true = pass, false = filter)
Error:  error

Rule = {
    Field:    "field_name"
    Operator: "eq|contains|regex|gt|lt|in|range"
    Value:    interface{}
    Enabled:  bool
}

Contract:
- Must handle missing fields gracefully (return false)
- Must handle type mismatches (log warning, return false)
- Must be thread-safe (RWMutex on rules cache)
- Must not modify input message
- Must cache compiled regex patterns
```

#### Exported Functions
```go
func (fs *FilteringService) Process(ctx context.Context, msg Message) (bool, error)
func (fs *FilteringService) GetRules() []Rule
func (fs *FilteringService) UpsertRule(ctx context.Context, rule Rule) error
func (fs *FilteringService) DeleteRule(ctx context.Context, ruleID string) error
func (fs *FilteringService) ReloadRules() error
```

---

### 2. Deduplication Service Contract

#### Input Message Type (same as output of Filtering)
```go
type Message map[string]interface{} {
    "id": string (required)
    "timestamp": time.Time (required)
    "source": string (required)
    // fields from filtering...
    "filters_applied": {
        "rule_ids": []string
        "passed_at": time.Time
    }
}
```

#### Deduplication Contract
```
Input:  Message
Output: bool (true = unique, false = duplicate), error

Contract:
- Must extract configurable fields for hashing
- Must use consistent hash algorithm (MD5 or SHA256)
- Must set Redis TTL on insertion
- Must handle Redis connection failures gracefully
- Must be idempotent (repeated calls return same result)
- Must not modify input message
- Must update cache hit rate metric
```

#### Exported Functions
```go
func (ds *DeduplicationService) Process(ctx context.Context, msg Message) (bool, error)
func (ds *DeduplicationService) UpdateWindow(window time.Duration)
func (ds *DeduplicationService) GetCacheStats() CacheStats
func (ds *DeduplicationService) ClearCache(ctx context.Context) error
```

---

### 3. Enrichment Service Contract

#### Input Message Type
```go
type Message map[string]interface{} {
    // all previous fields...
    "filters_applied": {...}
    "deduplication": {...}
}
```

#### Enrichment Contract
```
Input:  Message, Rules
Output: EnrichedMessage, error

EnrichedMessage = {
    ...original message fields...
    "enrichment": {
        "data": {...}
        "rules_applied": []string
        "cache_hit": bool
        "enriched_at": time.Time
    }
}

Contract:
- Must not block pipeline on enrichment errors
- Must respect timeout for external API calls
- Must cache results with configurable TTL
- Must support fallback values
- Must handle partial enrichment (not all rules succeed)
- Must be thread-safe
- Must log all failures with details
- Must add enrichment metadata to message
```

#### Exported Functions
```go
func (es *EnrichmentService) Process(ctx context.Context, msg Message) (*Message, error)
func (es *EnrichmentService) GetRules() []EnrichmentRule
func (es *EnrichmentService) UpsertRule(ctx context.Context, rule EnrichmentRule) error
func (es *EnrichmentService) DeleteRule(ctx context.Context, ruleID string) error
func (es *EnrichmentService) ClearCache(ctx context.Context) error
```

---

### 4. Message Broker Contract

#### Producer Contract
```
func Publish(ctx context.Context, queue string, msg interface{}) error

Contract:
- Must serialize msg to JSON
- Must ensure queue exists
- Must handle connection failures with retry
- Must support acknowledgements
- Must timeout configurable (default 30s)
- Must add message metadata (timestamp, correlation_id)
```

#### Consumer Contract
```
func Consume(ctx context.Context, queue string) (<-chan Message, error)

Contract:
- Must support multiple concurrent consumers
- Must handle backpressure
- Must support manual/auto acknowledgement
- Must support error handling and DLQ routing
- Must preserve message ordering (per partition if Kafka)
- Must support graceful shutdown
```

---

### 5. Management Service Contract

#### Rule Validation Contract
```go
func ValidateFilteringRule(rule Rule) error

Validations:
- Field must not be empty
- Operator must be in predefined list
- Value must be compatible with operator
- Priority must be >= 0
- Name must be unique (or return version)

Returns:
- nil if valid
- ValidationError with detailed message if invalid
```

#### CRUD Contract
```
Create:
  Input:  Rule
  Output: Rule (with ID, timestamps), error
  
Read:
  Input:  ID
  Output: Rule, error
  
Update:
  Input:  ID, Rule
  Output: Rule (updated), error
  
Delete:
  Input:  ID
  Output: error

Contract:
- Must enforce permissions (RBAC optional)
- Must support soft deletes (or hard delete with audit trail)
- Must maintain version history
- Must notify services about changes
- Must validate before saving
- Must use transactions
```

---

### 6. Service-to-Service Communication

#### Health Check Contract
```
Endpoint: GET /health
Response: {
  "status": "healthy|degraded|unhealthy",
  "timestamp": time.Time,
  "uptime": duration,
  "database": "connected|disconnected",
  "broker": "connected|disconnected",
  "errors": []string
}
```

#### Metrics Export Contract
```
Endpoint: GET /metrics
Format:   Prometheus text format
Metrics:
  - {service}.messages.total (counter)
  - {service}.messages.success (counter)
  - {service}.messages.failed (counter)
  - {service}.messages.duration_ms (histogram)
  - {service}.cache.hit_rate (gauge)
  - {service}.queue.depth (gauge)
```

---

### 7. Error Handling Contract

#### Error Types
```go
// Recoverable errors (retry possible)
type RetryableError struct { ... }

// Non-recoverable errors (send to DLQ)
type FatalError struct { ... }

// Validation errors
type ValidationError struct { ... }

// Timeout errors
type TimeoutError struct { ... }

// Configuration errors
type ConfigError struct { ... }
```

#### Error Response Format
```json
{
  "error": "error message",
  "error_code": "ERROR_CODE",
  "timestamp": "2025-12-14T14:55:00Z",
  "trace_id": "trace-54321",
  "details": {
    "field": "value",
    "reason": "why it failed"
  }
}
```

#### Retry Policy
```
Max Retries:     3
Backoff:         exponential (1s, 2s, 4s)
Timeout:         30 seconds per retry
Circuit Breaker: open after 5 consecutive failures (reset after 1 min)
```

---

